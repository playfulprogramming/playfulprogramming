---
import Document from "src/layouts/document.astro";
import SEO from "components/seo/seo.astro";
import { Languages } from "types/index";
import BlogPost from "src/views/blog-post/blog-post.astro";
import * as api from "utils/api";
import { getMarkdownHtml } from "utils/markdown";
import { isDefined } from "utils/is-defined";
import { getPostImages } from "utils/hoof";

const params = Astro.params as {
	locale: Languages;
	postid: string;
};

const slug = params.postid;

const locale = params.locale ?? "en";
const post = api.getPostBySlug(slug, locale)!;

const upToDateSlug = post?.upToDateSlug || undefined;

if (!post) {
	return Astro.redirect("/404");
}

const authors = post.authors
	.map((personId) => api.getPersonById(personId, locale))
	.filter(isDefined);

// the most recent version of a post does not have an upToDateSlug; also we have to use the upToDateSlug of an old version to fetch the other versions of said post
const versions = api.getPostVersionsBySlug(upToDateSlug || slug, locale);

// these need to be separate; multiple posts *can* be in a collection without having a collection entry
const collection = post.collection
	? api.getCollectionBySlug(post.collection, locale)
	: undefined;
const collectionPosts = post.collection
	? api.getPostsByCollection(post.collection, locale)
	: undefined;

const locales = post?.locales || [];

const postHtml = await getMarkdownHtml(post);
const postImages = await getPostImages(post).catch((e) => {
	console.error(e);
	return undefined;
});
---

<Document size="xl">
	<SEO
		slot="head"
		title={post.title}
		description={post.description}
		peopleData={authors}
		publishedTime={post.published}
		editedTime={post.edited}
		keywords={post.tags}
		type="article"
		canonical={post.originalLink}
		providedLangs={locales}
		shareImage={postImages?.linkPreview}
		noindex={post.noindex}
	/>
	<BlogPost
		post={post}
		postHtml={postHtml}
		authors={authors}
		versions={versions}
		collection={collection}
		collectionPosts={collectionPosts}
	/>
</Document>
