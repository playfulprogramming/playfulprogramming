---
import { IFramePlaceholderProps } from "components/iframe-placeholder/iframe-placeholder";
import { VideoPlaceholder } from "components/video/video-placeholder";
import {
	getIFrameAttributes,
	getOEmbedDataFromUrl,
} from "utils/markdown/oembed";

export type Props = IFramePlaceholderProps;

const props = Astro.props;

let title = props.pageTitle;
let thumbnail = "/illustrations/illustration-webpage.svg";
let iframeProps = {};

interface YouTubeOEmbedResponse {
	title: string;
	author_name: string;
	author_url: string;
	type: "video";
	height: number;
	width: number;
	version: "1.0";
	provider_name: string;
	provider_url: string;
	thumbnail_height: number;
	thumbnail_width: number;
	thumbnail_url: string;
	html: string;
}

const json = await getOEmbedDataFromUrl<YouTubeOEmbedResponse>(props.src).catch(
	() => null,
);

if (json) {
	title = `${json.title}`;
	thumbnail = json.thumbnail_url;
	const {
		height: _height,
		width: _width,
		...otherIframeProps
	} = await getIFrameAttributes(json.html);
	iframeProps = otherIframeProps;
}
---

<VideoPlaceholder
	{...props}
	pageTitle={title}
	thumbnailUrl={thumbnail}
	iframeAttrs={{ ...iframeProps, ...props.iframeAttrs }}
	client:visible
/>
