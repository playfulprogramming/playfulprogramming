---
import * as Terser from "terser";

import {
	COLOR_MODE_STORAGE_KEY,
	THEME_COLOR_DARK,
	THEME_COLOR_LIGHT,
} from "../../constants";
import { serializeInlineCall } from "utils/serialize-inline-call";

/**
 * Much of this code deals with dark mode. It's ripped straight from:
 * @see https://joshwcomeau.com/gatsby/dark-mode/
 *
 * Huge thanks to Josh for outlining how to do this
 */
/**
 * DARK MODE CODE
 *
 * Prevents the "flash" of light mode
 */
const setColorsByTheme = serializeInlineCall(
	({
		storageKey,
		lightTheme,
		darkTheme,
	}: {
		storageKey: string;
		lightTheme: string;
		darkTheme: string;
	}): void => {
		const mql = window.matchMedia("(prefers-color-scheme: dark)");
		const prefersDarkFromMQ = mql.matches;
		const prefersDarkFromLocalStorage = localStorage.getItem(storageKey);
		const hasUsedToggle = typeof prefersDarkFromLocalStorage === "string";

		const colorMode = hasUsedToggle
			? prefersDarkFromLocalStorage
			: prefersDarkFromMQ
				? "dark"
				: "light";

		// TODO: migrate to `classList`
		document.documentElement.className = colorMode;

		// update the meta theme-color attribute(s) based on the user preference
		const bgColor = colorMode === "light" ? lightTheme : darkTheme;
		// this needs to update both meta tags so that it applies regardless of prefers-color-scheme
		document
			.querySelectorAll("meta[name='theme-color']")
			.forEach((el) => el.setAttribute("content", bgColor));
	},
);

const inlineScript = setColorsByTheme({
	storageKey: COLOR_MODE_STORAGE_KEY,
	lightTheme: THEME_COLOR_LIGHT,
	darkTheme: THEME_COLOR_DARK,
});

const calledFunction = (await Terser.minify(inlineScript)).code!;
---

<script is:inline set:html={calledFunction} />
